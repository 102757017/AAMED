name: ä¸º Windows ç¼–è¯‘ pyAAMED

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build_windows:
    runs-on: windows-2022

    env:
      OPENCV_VERSION: "4.10.0"
      OPENCV_PYTHON_VERSION: "4.10.0.84" # ğŸ‘ˆ ä¿®æ­£ï¼šæ¢å¤æ­¤è¡Œï¼Œç¡®ä¿ç‰ˆæœ¬å˜é‡å¯ç”¨ï¼
      OPENCV_BUILD_VERSION: "4100"

    strategy:
      matrix:
        # ä¿®æ­£ï¼šæ ¹æ®æ‚¨çš„å»ºè®®ï¼Œç§»é™¤ Python 3.8ï¼Œåªç¼–è¯‘ Python 3.11ã€‚
        python-version: ["3.11"]

    steps:
    - name: æ£€å‡ºä»“åº“ä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python ${{ matrix.python-version }} ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: è®¾ç½® MSVC C++ ç¼–è¯‘ç¯å¢ƒ
      uses: microsoft/setup-msbuild@v2

    - name: å®‰è£…ä¾èµ– (NumPy å’Œ OpenCV-Python)
      shell: powershell
      run: |
        $OutputEncoding = [System.Text.Encoding]::UTF8 # ç¡®ä¿ PowerShell è¾“å‡ºæ­£ç¡®æ˜¾ç¤º
        python -m pip install --upgrade pip
        # ç°åœ¨ OPENCV_PYTHON_VERSION å˜é‡å·²æ­£ç¡®å®šä¹‰ï¼Œæ­¤å‘½ä»¤å°†æ­£å¸¸æ‰§è¡Œ
        pip install numpy "opencv-python==${{ env.OPENCV_PYTHON_VERSION }}"
      working-directory: ./python

    - name: ä¸‹è½½å¹¶å‡†å¤‡ OpenCV C++ åº“ (å¥å£®ç‰ˆ)
      shell: powershell
      run: |
        $OutputEncoding = [System.Text.Encoding]::UTF8 # ç¡®ä¿ PowerShell è¾“å‡ºæ­£ç¡®æ˜¾ç¤º

        $opencv_version = "${{ env.OPENCV_VERSION }}"
        $opencv_zip = "opencv-$opencv_version-windows.exe"
        $opencv_install_dir = "D:/opencv-manually-built"
        $download_url = "https://github.com/opencv/opencv/releases/download/$opencv_version/$opencv_zip"

        Write-Host "æ­£åœ¨ä»å®˜æ–¹ GitHub Releases ä¸‹è½½ OpenCV $opencv_version..."
        curl -L -o $opencv_zip $download_url --retry 3 --retry-delay 5
        
        $file_size_mb = (Get-Item $opencv_zip).Length / 1MB
        Write-Host "ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $($file_size_mb.ToString('F2')) MB"
        if ($file_size_mb -lt 500) { # å‡è®¾ OpenCV exe å®‰è£…åŒ…é€šå¸¸å¤§äº 500MB
            Write-Error "é”™è¯¯ï¼šä¸‹è½½çš„ OpenCV æ–‡ä»¶å¤§å°å¼‚å¸¸ï¼Œå¯èƒ½ä¸æ˜¯å®Œæ•´å®‰è£…åŒ…ï¼"
            exit 1
        }

        New-Item -ItemType Directory -Path $opencv_install_dir -Force
        # ä½¿ç”¨ -t å‚æ•°æŒ‡å®šç›®æ ‡ç›®å½•
        7z.exe x $opencv_zip -o"$opencv_install_dir" > $null # éšè— 7z è¾“å‡ºï¼Œå¦‚æœä¸éœ€è¦è¯¦ç»†æ—¥å¿—
        # éªŒè¯è§£å‹åæ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨
        if (-Not (Test-Path "$opencv_install_dir/opencv")) {
            Write-Error "é”™è¯¯ï¼šOpenCV æœªèƒ½æ­£ç¡®è§£å‹åˆ° $opencv_install_dir/opencv"
            exit 1
        }

        Write-Host "OpenCV å·²è§£å‹åˆ°: $opencv_install_dir/opencv"

        Copy-Item -Path "python/setup.py" -Destination "python/setup_modified.py" -Force
        $setup_content = Get-Content "python/setup_modified.py"
        $new_setup_content = $setup_content -replace 'opencv_root\s*=\s*""', ('opencv_root = "' + $opencv_install_dir + '/opencv/build"')
        Set-Content -Path "python/setup_modified.py" -Value $new_setup_content
      working-directory: .

    - name: ç¼–è¯‘ pyAAMED æ‰©å±•æ¨¡å—
      shell: powershell
      run: |
        $OutputEncoding = [System.Text.Encoding]::UTF8 # ç¡®ä¿ PowerShell è¾“å‡ºæ­£ç¡®æ˜¾ç¤º
        python setup_modified.py build_ext --inplace
      working-directory: ./python
      
    - name: éªŒè¯ç¼–è¯‘è¾“å‡ºå¹¶æ”¶é›†äº§ç‰©
      shell: powershell
      run: |
        $OutputEncoding = [System.Text.Encoding]::UTF8
        Write-Host "æ­£åœ¨æŸ¥æ‰¾ç¼–è¯‘äº§ç‰©..."
        $pyd_files = Get-ChildItem -Path python -Filter "pyAAMED*.pyd" -Recurse # ç¡®ä¿åœ¨ python å­ç›®å½•ä¸­æŸ¥æ‰¾
        if ($null -eq $pyd_files) {
            Write-Error "é”™è¯¯ï¼šæœªåœ¨ 'python/' ç›®å½•ä¸­æ‰¾åˆ°ç¼–è¯‘ç”Ÿæˆçš„ .pyd æ–‡ä»¶ï¼"
            exit 1
        }
        Write-Host "å·²æ‰¾åˆ° PYD æ–‡ä»¶: $($pyd_files.FullName)"
        
        # å°† OpenCV çš„ DLL å¤åˆ¶åˆ° pyd æ–‡ä»¶æ—è¾¹ï¼Œç¡®ä¿è¿è¡Œæ—¶èƒ½æ‰¾åˆ°
        # æ³¨æ„ï¼šè¿™é‡Œå¯èƒ½éœ€è¦æ ¹æ®å®é™… OpenCV è§£å‹åçš„è·¯å¾„è°ƒæ•´
        $opencv_dll_source_path = "$opencv_install_dir/opencv/build/x64/vc16/bin/opencv_world${{ env.OPENCV_BUILD_VERSION }}.dll"
        $opencv_dll_destination_path = "python/" # å¤åˆ¶åˆ° python ç›®å½•
        
        if (-Not (Test-Path $opencv_dll_source_path)) {
            Write-Error "é”™è¯¯: åœ¨é¢„æœŸçš„ OpenCV è§£å‹è·¯å¾„ä¸­æœªæ‰¾åˆ°éœ€è¦çš„ DLL: $opencv_dll_source_path"
            # å°è¯•æŸ¥æ‰¾å…¶ä»–å¯èƒ½çš„ DLL è·¯å¾„ï¼Œä¾‹å¦‚ vc17
            $vc17_dll_path = "$opencv_install_dir/opencv/build/x64/vc17/bin/opencv_world${{ env.OPENCV_BUILD_VERSION }}.dll"
            if (Test-Path $vc17_dll_path) {
                Write-Host "åœ¨ $vc17_dll_path æ‰¾åˆ°äº† DLLï¼Œå°†ä½¿ç”¨æ­¤è·¯å¾„ã€‚"
                $opencv_dll_source_path = $vc17_dll_path
            } else {
                exit 1 # å¦‚æœ vc17 ä¹Ÿæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™å½»åº•å¤±è´¥
            }
        }
        Copy-Item -Path $opencv_dll_source_path -Destination $opencv_dll_destination_path -Force
        Write-Host "å·²å°† OpenCV DLL ä» '$opencv_dll_source_path' å¤åˆ¶åˆ° '$opencv_dll_destination_path'"
      working-directory: . # æ³¨æ„ï¼šè¿™é‡Œæ˜¯ä»“åº“æ ¹ç›®å½•ï¼Œå› ä¸ºå‰é¢æœ‰ python/ è·¯å¾„é™å®š

    - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰© (pyAAMED.pyd å’Œ OpenCV DLL)
      uses: actions/upload-artifact@v4
      with:
        name: pyAAMED-py${{ matrix.python-version }}-windows
        path: |
          python/*.pyd
          python/opencv_world*.dll
        retention-days: 7

