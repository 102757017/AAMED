name: ä¸º Windows ç¼–è¯‘ pyAAMED

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build_windows:
    runs-on: windows-2022

    env:
      OPENCV_VERSION: "4.10.0"
      OPENCV_PYTHON_VERSION: "4.10.0.84"
      OPENCV_BUILD_VERSION: "4100"

    strategy:
      matrix:
        python-version: ["3.11"]

    steps:
    - name: æ£€å‡ºä»“åº“ä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python ${{ matrix.python-version }} ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: è®¾ç½® MSVC C++ ç¼–è¯‘ç¯å¢ƒ
      uses: microsoft/setup-msbuild@v2

    - name: å®‰è£…ä¾èµ– (Cython, NumPy, å’Œ OpenCV-Python)
      shell: pwsh
      run: |
        $OutputEncoding = [System.Text.Encoding]::UTF8
        python -m pip install --upgrade pip
        pip install Cython numpy "opencv-python==${{ env.OPENCV_PYTHON_VERSION }}"
      working-directory: ./python

    - name: ä¸‹è½½å¹¶å‡†å¤‡ OpenCV C++ åº“ (ä¿®æ­£ IndentationError ç‰ˆæœ¬)
      shell: pwsh
      run: |
        $OutputEncoding = [System.Text.Encoding]::UTF8

        $opencv_version = "${{ env.OPENCV_VERSION }}"
        $opencv_zip = "opencv-$opencv_version-windows.exe"
        $opencv_install_dir = "D:/opencv-manually-built"
        $download_url = "https://github.com/opencv/opencv/releases/download/$opencv_version/$opencv_zip"

        Write-Host "æ­£åœ¨ä»å®˜æ–¹ GitHub Releases ä¸‹è½½ OpenCV $opencv_version..."
        curl -L -o $opencv_zip $download_url --retry 3 --retry-delay 5
        
        $file_size_mb = (Get-Item $opencv_zip).Length / 1MB
        Write-Host "ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $($file_size_mb.ToString('F2')) MB"
        if ($file_size_mb -lt 100) { 
            Write-Error "é”™è¯¯ï¼šä¸‹è½½çš„ OpenCV æ–‡ä»¶å¤§å°å¼‚å¸¸ï¼Œå¯èƒ½ä¸æ˜¯å®Œæ•´å®‰è£…åŒ…ï¼"
            exit 1
        }

        New-Item -ItemType Directory -Path $opencv_install_dir -Force
        7z.exe x $opencv_zip -o"$opencv_install_dir" > $null
        if (-Not (Test-Path "$opencv_install_dir/opencv")) {
            Write-Error "é”™è¯¯ï¼šOpenCV æœªèƒ½æ­£ç¡®è§£å‹åˆ° $opencv_install_dir/opencv"
            exit 1
        }

        Write-Host "OpenCV å·²è§£å‹åˆ°: $opencv_install_dir/opencv"

        Write-Host "æ£€æŸ¥å¹¶æ·»åŠ  MSYS2 bin ç›®å½•åˆ° PATH..."
        $msys2_bin_path = "C:\msys64\usr\bin"
        if (Test-Path $msys2_bin_path) {
            Add-Content -Path $env:GITHUB_PATH -Value $msys2_bin_path
            Write-Host "å·²å°† $msys2_bin_path æ·»åŠ åˆ°æœ¬æ¬¡è¿è¡Œçš„ PATH (é€šè¿‡ GITHUB_PATH)ã€‚"
        } else {
            Write-Warning "MSYS2 å®‰è£…è·¯å¾„ ($msys2_bin_path) æœªæ‰¾åˆ°ã€‚å¦‚æœ setup.py ä¾èµ– pkg-configï¼Œè¿™å¯èƒ½å¯¼è‡´å¤±è´¥ã€‚"
        }

        Add-Content -Path $env:GITHUB_ENV -Value "OPENCV_ROOT=$($opencv_install_dir)/opencv/build"
        Write-Host "å·²è®¾ç½®ç¯å¢ƒå˜é‡ OPENCV_ROOT=$($opencv_install_dir)/opencv/build (é€šè¿‡ GITHUB_ENV)ã€‚"

        # ğŸ¯ æ ¸å¿ƒä¿®æ­£ï¼šä¿®æ”¹ setup.py ä»¥ç¦ç”¨åŠ¨æ€ç‰ˆæœ¬æ£€æµ‹ï¼Œç›´æ¥ä½¿ç”¨ç¯å¢ƒå˜é‡æä¾›çš„ç‰ˆæœ¬
        Copy-Item -Path "python/setup.py" -Destination "python/setup_modified.py" -Force
        $setup_file_content_lines = Get-Content "python/setup_modified.py" # ç›´æ¥è¯»å–ä¸ºè¡Œæ•°ç»„

        $temp_modified_lines = @()
        $os_import_present = $false
        
        # ç¬¬ä¸€ééå†ï¼šæ£€æŸ¥ 'import os' å’Œæ›¿æ¢ 'opencv_root'
        foreach ($line in $setup_file_content_lines) {
            if ($line -match '^\s*import os\s*$') {
                $os_import_present = $true
            }
            if ($line -match 'opencv_root\s*=\s*""') {
                $temp_modified_lines += ('opencv_root = "' + $opencv_install_dir + '/opencv/build"')
            } else {
                $temp_modified_lines += $line
            }
        }
        
        # å¦‚æœæ–‡ä»¶é¡¶éƒ¨æ²¡æœ‰ 'import os'ï¼Œåˆ™æ·»åŠ 
        if (-not $os_import_present) {
            $temp_modified_lines = @("import os") + $temp_modified_lines
            Write-Host "å·²åœ¨ setup_modified.py é¡¶éƒ¨æ·»åŠ  'import os'ã€‚"
        }
        
        # ç¬¬äºŒééå†ï¼šæ›¿æ¢åŠ¨æ€è·å– opencv_src_version çš„ä»£ç è¡Œï¼Œå¹¶è·³è¿‡éšåçš„ç¼©è¿›éƒ¨åˆ†
        $final_setup_content_lines = @()
        $in_subprocess_block = $false # æ–°æ ‡å¿—ï¼ŒæŒ‡ç¤ºæˆ‘ä»¬æ˜¯å¦åœ¨ä¸€ä¸ª subprocess.check_output å—ä¸­
        $subprocess_block_start_indent = -1 # è®°å½•å—å¼€å§‹æ—¶çš„ç¼©è¿›çº§åˆ«
        $version_line_replaced = $false

        for ($i = 0; $i -lt $temp_modified_lines.Count; $i++) {
            $line = $temp_modified_lines[$i]
            $current_line_indent = ($line -replace '^(\s*).*', '$1').Length # è·å–å½“å‰è¡Œå‰å¯¼ç©ºç™½çš„é•¿åº¦

            if ($line -match 'opencv_src_version\s*=\s*subprocess\.check_output') {
                $final_setup_content_lines += "opencv_src_version = os.environ.get('OPENCV_VERSION', '$($env:OPENCV_VERSION)')"
                Write-Host "å·²æ›¿æ¢ setup_modified.py ä¸­åŠ¨æ€è·å– opencv_src_version çš„èµ·å§‹ä»£ç è¡Œã€‚"
                $in_subprocess_block = $true
                $version_line_replaced = $true
                $subprocess_block_start_indent = ($line -replace '^(\s*).*', '$1').Length # è®°å½•èµ·å§‹è¡Œçš„ç¼©è¿›
            } elseif ($in_subprocess_block) {
                # å¦‚æœæˆ‘ä»¬åœ¨å—ä¸­ï¼Œå¹¶ä¸”å½“å‰è¡Œæ¯”èµ·å§‹è¡Œç¼©è¿›æ›´æ·±ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªç©ºè¡Œä½†ä»åœ¨å—çš„ç¼©è¿›èŒƒå›´å†…
                if ($current_line_indent -gt $subprocess_block_start_indent -or ($line.Trim() -eq '' -and $current_line_indent -ge $subprocess_block_start_indent)) {
                    Write-Host "è·³è¿‡åŸå§‹ subprocess è°ƒç”¨ä¸­çš„ç¼©è¿›è¡Œæˆ–ç©ºç™½è¡Œ: $line"
                    # ä¸å°†æ­¤è¡Œæ·»åŠ åˆ°æœ€ç»ˆå†…å®¹ä¸­
                } else {
                    # å½“å‰è¡Œç¼©è¿›ä¸å†æ¯”èµ·å§‹è¡Œæ·±ï¼Œæˆ–è€…ç¼©è¿›ç›¸åŒä½†ä¸æ˜¯ç©ºè¡Œï¼Œè¡¨ç¤ºå—ç»“æŸ
                    $in_subprocess_block = $false
                    $subprocess_block_start_indent = -1 # é‡ç½®ç¼©è¿›è®°å½•
                    $final_setup_content_lines += $line # æ·»åŠ å½“å‰è¡Œï¼Œå› ä¸ºå®ƒæ˜¯å—å¤–éƒ¨çš„ç¬¬ä¸€è¡Œ
                    Write-Host "æ£€æµ‹åˆ° subprocess.check_output å—ç»“æŸã€‚æ·»åŠ è¡Œ: $line"
                }
            } else {
                $final_setup_content_lines += $line # æ·»åŠ å¸¸è§„è¡Œ
            }
        }

        if (-not $version_line_replaced) {
            Write-Warning "æœªè‡ªåŠ¨æ›¿æ¢ setup_modified.py ä¸­åŠ¨æ€è·å– opencv_src_version çš„ä»£ç è¡Œã€‚è¯·æ‰‹åŠ¨æ£€æŸ¥æ–‡ä»¶å†…å®¹ï¼Œç‰¹åˆ«æ˜¯é¢„è®¡çš„è¡Œ 30ã€‚"
            Write-Warning "å¦‚æœè¡Œ 30 ç¡®å®æ˜¯ subprocess.check_output è°ƒç”¨ï¼Œæ‚¨å¯èƒ½éœ€è¦æ‰‹åŠ¨è°ƒæ•´æ­£åˆ™è¡¨è¾¾å¼æˆ–ç›´æ¥ç¼–è¾‘ setup.pyã€‚"
        }
        
        # å°†ä¿®æ”¹åçš„è¡Œæ•°ç»„ç”¨æ¢è¡Œç¬¦è¿æ¥èµ·æ¥ï¼Œå¹¶å†™å…¥æ–‡ä»¶
        # PowerShell çš„ Set-Content ä¼šè‡ªåŠ¨å¤„ç†æ•°ç»„å’Œæ¢è¡Œç¬¦ï¼Œä½†ä¸ºäº†æ˜ç¡®ï¼Œæˆ‘ä»¬ä»ä½¿ç”¨ -join "`n"
        Set-Content -Path "python/setup_modified.py" -Value ($final_setup_content_lines -join "`n")

      working-directory: .

    - name: ç¼–è¯‘ pyAAMED æ‰©å±•æ¨¡å—
      shell: pwsh
      run: |
        $OutputEncoding = [System.Text.Encoding]::UTF8
        python setup_modified.py build_ext --inplace
      working-directory: ./python
      
    - name: éªŒè¯ç¼–è¯‘è¾“å‡ºå¹¶æ”¶é›†äº§ç‰©
      shell: pwsh
      run: |
        $OutputEncoding = [System.Text.Encoding]::UTF8
        Write-Host "æ­£åœ¨æŸ¥æ‰¾ç¼–è¯‘äº§ç‰©..."
        $pyd_files = Get-ChildItem -Path python -Filter "pyAAMED*.pyd" -Recurse
        if ($null -eq $pyd_files) {
            Write-Error "é”™è¯¯ï¼šæœªåœ¨ 'python/' ç›®å½•ä¸­æ‰¾åˆ°ç¼–è¯‘ç”Ÿæˆçš„ .pyd æ–‡ä»¶ï¼"
            exit 1
        }
        Write-Host "å·²æ‰¾åˆ° PYD æ–‡ä»¶: $($pyd_files.FullName)"
        
        $opencv_dll_path_base = "$opencv_install_dir/opencv/build/x64"
        $opencv_dll_source_path = ""

        if (Test-Path "$opencv_dll_path_base/vc16/bin/opencv_world${{ env.OPENCV_BUILD_VERSION }}.dll") {
            $opencv_dll_source_path = "$opencv_dll_path_base/vc16/bin/opencv_world${{ env.OPENCV_BUILD_VERSION }}.dll"
            Write-Host "åœ¨ vc16 è·¯å¾„æ‰¾åˆ°äº† DLLï¼š$opencv_dll_source_path"
        } 
        elseif (Test-Path "$opencv_dll_path_base/vc17/bin/opencv_world${{ env.OPENCV_BUILD_VERSION }}.dll") {
            $opencv_dll_source_path = "$opencv_dll_path_base/vc17/bin/opencv_world${{ env:OPENCV_BUILD_VERSION }}.dll"
            Write-Host "åœ¨ vc17 è·¯å¾„æ‰¾åˆ°äº† DLLï¼š$opencv_dll_source_path"
        } else {
            Write-Error "é”™è¯¯: åœ¨é¢„æœŸçš„ OpenCV è§£å‹è·¯å¾„ä¸­æœªæ‰¾åˆ°éœ€è¦çš„ DLL (vc16 æˆ– vc17): $($opencv_dll_path_base)/vc16/bin æˆ– $($opencv_dll_path_base)/vc17/bin"
            exit 1
        }

        $opencv_dll_destination_path = "python/"
        Copy-Item -Path $opencv_dll_source_path -Destination $opencv_dll_destination_path -Force
        Write-Host "å·²å°† OpenCV DLL ä» '$opencv_dll_source_path' å¤åˆ¶åˆ° '$opencv_dll_destination_path'"
      working-directory: .

    - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰© (pyAAMED.pyd å’Œ OpenCV DLL)
      uses: actions/upload-artifact@v4
      with:
        name: pyAAMED-py${{ matrix.python-version }}-windows
        path: |
          python/*.pyd
          python/opencv_world*.dll
        retention-days: 7
